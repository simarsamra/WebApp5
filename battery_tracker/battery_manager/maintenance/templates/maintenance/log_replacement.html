{% extends 'maintenance/base.html' %}
{% load static %}

{% block title %}Log Replacement{% endblock %}

{% block content %}
    <h1>Log Replacement</h1>
    
    <!-- Filters Section -->
    <div class="filters">
        <form id="filterForm" class="filter-form">
            <div class="filter-group">
                <label for="building">Building:</label>
                <select name="building" id="building">
                    <option value="">All Buildings</option>
                    {% for building in buildings %}
                        <option value="{{ building }}" {% if building == selected_building %}selected{% endif %}>
                            {{ building }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="machine">Machine:</label>
                <select name="machine" id="machine">
                    <option value="">All Machines</option>
                </select>
            </div>
        </form>
    </div>

    <!-- Replacement Form -->
    <form method="POST" class="replacement-form">
        {% csrf_token %}
        <div class="form-group">
            <label for="record_id">Select Replacement Record:</label>
            <select name="record_id" id="record_id">
                {% for record in records %}
                    <option value="{{ record.id }}">
                        {{ record.component.machine.building }} - 
                        {{ record.component.machine.model }} - 
                        {{ record.component.component_model }} - 
                        Due on {{ record.due_date }}
                    </option>
                {% empty %}
                    <option disabled>No records found matching the filters</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="replacement_date">Replacement Date:</label>
            <input type="date" id="replacement_date" name="replacement_date" value="{{ today|date:'Y-m-d' }}">
            <button type="button" id="setToday" class="today-button">Set Today</button>
        </div>

        <button type="submit" class="submit-button">Log Replacement</button>
    </form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const buildingSelect = document.getElementById('building');
    const machineSelect = document.getElementById('machine');
    const recordSelect = document.getElementById('record_id');
    const dateInput = document.getElementById('replacement_date');
    const todayButton = document.getElementById('setToday');

    // Load initial machines if building is selected
    if (buildingSelect.value) {
        updateMachines(buildingSelect.value);
    }

    // Update machines when building changes
    buildingSelect.addEventListener('change', function() {
        updateMachines(this.value);
    });

    // Update records when machine changes
    machineSelect.addEventListener('change', function() {
        updateRecords();
    });

    async function updateMachines(building) {
        try {
            const response = await fetch(`/api/machines/?building=${encodeURIComponent(building)}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const machines = await response.json();
            
            machineSelect.innerHTML = '<option value="">All Machines</option>';
            machines.forEach(machine => {
                machineSelect.innerHTML += `
                    <option value="${machine.id}">
                        ${machine.model} (${machine.machine_id})
                    </option>
                `;
            });
            
            // Update records after updating machines
            updateRecords();
        } catch (error) {
            console.error('Error fetching machines:', error);
        }
    }

    async function updateRecords() {
        try {
            const building = buildingSelect.value;
            const machine = machineSelect.value;
            const response = await fetch(`/api/records/?building=${encodeURIComponent(building)}&machine=${encodeURIComponent(machine)}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const records = await response.json();
            
            recordSelect.innerHTML = '';
            if (records.length === 0) {
                recordSelect.innerHTML = '<option disabled>No records found matching the filters</option>';
            } else {
                records.forEach(record => {
                    recordSelect.innerHTML += `
                        <option value="${record.id}">
                            ${record.component.machine.building} - 
                            ${record.component.machine.model} - 
                            ${record.component.component_model} - 
                            Due on ${record.due_date}
                        </option>
                    `;
                });
            }
        } catch (error) {
            console.error('Error fetching records:', error);
        }
    }

    // Set today's date
    todayButton.addEventListener('click', function() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;
    });

    // Load initial records
    updateRecords();
});
</script>
{% endblock %}